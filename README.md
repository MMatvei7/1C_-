Задача решена с помощью перебора состояний куч. Для этого использовался DFS с подсчетом числа шагов.
